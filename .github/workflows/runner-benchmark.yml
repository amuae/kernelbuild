name: Runner 性能测试

on:
  workflow_dispatch:
    inputs:
      run_geekbench:
        description: '运行 Geekbench 5 测试'
        required: false
        default: true
        type: boolean

jobs:
  benchmark:
    name: "性能测试"
    runs-on: ubuntu-24.04
    
    steps:
      - name: 系统信息概览
        run: |
          echo "=========================================="
          echo "           GitHub Runner 配置信息"
          echo "=========================================="
          
          echo ""
          echo ">>> 操作系统信息"
          echo "----------------------------------------"
          cat /etc/os-release
          uname -a
          
          echo ""
          echo ">>> CPU 信息"
          echo "----------------------------------------"
          lscpu | grep -E "^(Architecture|CPU\(s\)|Thread|Core|Socket|Model name|CPU MHz|CPU max|CPU min|Virtualization|Hypervisor)"
          echo ""
          echo "CPU 详细型号:"
          cat /proc/cpuinfo | grep "model name" | head -1
          echo ""
          echo "CPU 核心数: $(nproc)"
          echo "CPU 线程数: $(nproc --all)"
          
          echo ""
          echo ">>> 内存信息"
          echo "----------------------------------------"
          free -h
          echo ""
          echo "总内存: $(grep MemTotal /proc/meminfo)"
          echo "可用内存: $(grep MemAvailable /proc/meminfo)"
          
          echo ""
          echo ">>> 磁盘信息"
          echo "----------------------------------------"
          df -h
          echo ""
          echo "磁盘类型:"
          lsblk -d -o NAME,SIZE,TYPE,MODEL 2>/dev/null || echo "无法获取磁盘型号"
          
          echo ""
          echo ">>> 网络信息"
          echo "----------------------------------------"
          echo "公网 IP: $(curl -s ifconfig.me 2>/dev/null || echo '无法获取')"
          echo "下载速度测试 (GitHub):"
          curl -o /dev/null -w "速度: %{speed_download} bytes/sec\n" -s https://github.com/torvalds/linux/raw/master/COPYING 2>/dev/null || echo "测试失败"
          
          echo ""
          echo ">>> 编译器版本"
          echo "----------------------------------------"
          gcc --version | head -1 || echo "GCC 未安装"
          clang --version | head -1 || echo "Clang 未安装"
          
          echo ""
          echo ">>> 环境变量"
          echo "----------------------------------------"
          echo "RUNNER_OS: $RUNNER_OS"
          echo "RUNNER_ARCH: $RUNNER_ARCH"
          echo "RUNNER_NAME: $RUNNER_NAME"
          echo "GITHUB_ACTIONS: $GITHUB_ACTIONS"

      - name: 磁盘读写速度测试
        run: |
          echo "=========================================="
          echo "           磁盘性能测试"
          echo "=========================================="
          
          echo ""
          echo ">>> 写入速度测试 (1GB)"
          dd if=/dev/zero of=testfile bs=1M count=1024 conv=fdatasync 2>&1 | tail -1
          
          echo ""
          echo ">>> 读取速度测试 (清除缓存后)"
          sudo sh -c "sync && echo 3 > /proc/sys/vm/drop_caches"
          dd if=testfile of=/dev/null bs=1M 2>&1 | tail -1
          
          rm -f testfile

      - name: CPU 简单性能测试
        run: |
          echo "=========================================="
          echo "           CPU 简单性能测试"
          echo "=========================================="
          
          echo ""
          echo ">>> 单线程性能 (计算圆周率 5000 位)"
          time echo "scale=5000; 4*a(1)" | bc -l > /dev/null
          
          echo ""
          echo "CPU 简单测试完成，跳过编译测试，直接进入 Geekbench 5"

      - name: 下载 Geekbench 5
        if: inputs.run_geekbench == true
        run: |
          echo ">>> 下载 Geekbench 5..."
          curl -sL https://cdn.geekbench.com/Geekbench-5.5.1-Linux.tar.gz | tar xz
          
      - name: 运行 Geekbench 5
        if: inputs.run_geekbench == true
        run: |
          echo "=========================================="
          echo "           Geekbench 5 测试"
          echo "=========================================="
          
          cd Geekbench-5.5.1-Linux
          # Tryout 版本必须上传结果，不能用 --no-upload
          ./geekbench5 | tee gb5_result.txt
          
          echo ""
          echo ">>> 测试结果摘要"
          echo "----------------------------------------"
          grep -E "(Single-Core Score|Multi-Core Score|https://browser.geekbench.com)" gb5_result.txt || echo "请查看上方完整输出"

      - name: 总结
        run: |
          echo ""
          echo "=========================================="
          echo "           测试完成总结"
          echo "=========================================="
          echo ""
          echo "Runner 类型: GitHub Hosted (ubuntu-24.04)"
          echo "CPU 核心数: $(nproc)"
          echo "总内存: $(free -h | awk '/^Mem:/{print $2}')"
          echo "可用磁盘: $(df -h / | awk 'NR==2{print $4}')"
          echo ""
          echo "提示: 免费 runner 通常配置为 4 核 CPU + 16GB RAM"
