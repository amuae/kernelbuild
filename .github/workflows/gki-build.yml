name: æ„å»º GKI å†…æ ¸

permissions:
  contents: write
  actions: write

env:
  TZ: Asia/Shanghai

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android ç‰ˆæœ¬'
        required: true
        default: 'android14'
        type: choice
        options:
          - android14
          - android15
          - android16
      kernel_version:
        description: 'å†…æ ¸ç‰ˆæœ¬'
        required: true
        default: '6.1'
        type: choice
        options:
          - '6.1'
          - '6.6'
          - '6.12'
      sub_level:
        description: 'å†…æ ¸å­ç‰ˆæœ¬å· (å¦‚ 118ã€124 ç­‰)'
        required: true
        default: '118'
        type: string
      ksu_type:
        description: 'KernelSU å˜ä½“'
        required: true
        default: 'sukisu'
        type: choice
        options:
          - sukisu
          - ksunext
          - mksu
          - ksu
      kernel_suffix:
        description: 'å†…æ ¸åç§°åç¼€ (å¦‚: gca0ef6d17716-ab13624819)'
        required: false
        default: 'gca0ef6d17716-ab13624819'
        type: string
      build_time:
        description: 'æ„å»ºæ—¶é—´'
        required: false
        default: 'Tue Jun 10 18:59:08 UTC 2025'
        type: string
      create_release:
        description: 'åˆ›å»º Release'
        required: false
        default: false
        type: boolean

jobs:
  build:
    name: "æ„å»º ${{ inputs.android_version }}-${{ inputs.kernel_version }}.${{ inputs.sub_level }}"
    runs-on: ubuntu-24.04
    
    env:
      # åŠŸèƒ½å¼€å…³ (é»˜è®¤å€¼)
      SUSFS_ENABLE: true
      KPM_ENABLE: false
      LZ4KD_ENABLE: true
      IPSET_ENABLE: true
      BBG_ENABLE: true
      REKERNEL_ENABLE: true
      WIREGUARD_ENABLE: true
    
    steps:
      # ==================== ç¯å¢ƒå‡†å¤‡ ====================
      - name: æ¸…ç†ç£ç›˜ç©ºé—´å¹¶å®‰è£…ä¾èµ–
        run: |
          echo "===== åˆå§‹ç£ç›˜ç©ºé—´ ====="
          df -h
          
          sudo apt-mark hold firefox
          sudo apt-mark hold libc-bin
          sudo apt purge man-db -y
          sudo rm -rf /var/lib/man-db/auto-update
          sudo apt update
          sudo apt-get install -y --no-install-recommends binutils python-is-python3 libssl-dev libelf-dev ccache
          
          echo "===== æ¸…ç†åç£ç›˜ç©ºé—´ ====="
          df -h

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          CONFIG="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.sub_level }}"
          ROOT="$GITHUB_WORKSPACE"
          KERNEL_ROOT="$ROOT/$CONFIG"
          SUSFS4KSU="$ROOT/susfs4ksu"
          KERNEL_PATCHES="$ROOT/kernel_patches"
          ANYKERNEL3="$ROOT/AnyKernel3"
          
          echo "CONFIG=$CONFIG" >> $GITHUB_ENV
          echo "ROOT=$ROOT" >> $GITHUB_ENV
          echo "KERNEL_ROOT=$KERNEL_ROOT" >> $GITHUB_ENV
          echo "SUSFS4KSU=$SUSFS4KSU" >> $GITHUB_ENV
          echo "KERNEL_PATCHES=$KERNEL_PATCHES" >> $GITHUB_ENV
          echo "ANYKERNEL3=$ANYKERNEL3" >> $GITHUB_ENV
          echo "DEFCONFIG=$KERNEL_ROOT/common/arch/arm64/configs/gki_defconfig" >> $GITHUB_ENV
          
          mkdir -p "$KERNEL_ROOT"

      - name: é…ç½®æ„å»ºç¯å¢ƒ
        run: |
          AOSP_MIRROR=https://android.googlesource.com
          BRANCH=main-kernel-2025
          
          git clone $AOSP_MIRROR/kernel/prebuilts/build-tools -b $BRANCH --depth 1 kernel-build-tools &
          git clone $AOSP_MIRROR/platform/system/tools/mkbootimg -b $BRANCH --depth 1 mkbootimg &
          wait
          
          echo "AVBTOOL=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/bin/avbtool" >> $GITHUB_ENV
          echo "MKBOOTIMG=$GITHUB_WORKSPACE/mkbootimg/mkbootimg.py" >> $GITHUB_ENV
          echo "UNPACK_BOOTIMG=$GITHUB_WORKSPACE/mkbootimg/unpack_bootimg.py" >> $GITHUB_ENV
          echo "BOOT_SIGN_KEY_PATH=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/share/avb/testkey_rsa2048.pem" >> $GITHUB_ENV
          echo "PATH=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/bin:$PATH" >> $GITHUB_ENV
          
          # é…ç½® repo å·¥å…·
          mkdir -p ./git-repo
          curl -s https://storage.googleapis.com/git-repo-downloads/repo > ./git-repo/repo
          chmod a+rx ./git-repo/repo
          echo "REPO=$GITHUB_WORKSPACE/git-repo/repo" >> $GITHUB_ENV
          
          echo "æ„å»ºç¯å¢ƒé…ç½®å®Œæˆ"

      - name: è®¾ç½® boot ç­¾åå¯†é’¥
        env:
          BOOT_SIGN_KEY: ${{ secrets.BOOT_SIGN_KEY }}
        run: |
          if [ ! -z "$BOOT_SIGN_KEY" ]; then
            echo "$BOOT_SIGN_KEY" > ./kernel-build-tools/linux-x86/share/avb/testkey_rsa2048.pem
          fi

      - name: å…‹éš† AnyKernel3 å’Œä¾èµ–
        run: |
          ANYKERNEL_BRANCH="gki-2.0"
          SUSFS_BRANCH="gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}"
          
          git clone https://github.com/WildKernels/AnyKernel3.git -b "$ANYKERNEL_BRANCH" &
          git clone https://github.com/WildKernels/kernel_patches.git &
          wait

      # ==================== ä¸‹è½½å†…æ ¸æºç  ====================
      - name: ç¡®å®šå®‰å…¨è¡¥ä¸çº§åˆ«
        id: patch_level
        run: |
          # æ ¹æ® kernel_version å’Œ sub_level ç¡®å®š os_patch_level
          KERNEL_VER="${{ inputs.kernel_version }}"
          SUB_LEVEL="${{ inputs.sub_level }}"
          
          get_patch_level() {
            local kv=$1
            local sl=$2
            
            case "$kv" in
              "6.1")
                # Android 14 - 6.1 æ˜ å°„è¡¨
                case "$sl" in
                  25) echo "2023-10" ;;
                  43) echo "2023-11" ;;
                  57) echo "2024-01" ;;
                  68) echo "2024-03" ;;
                  75) echo "2024-05" ;;
                  78) echo "2024-06" ;;
                  84) echo "2024-07" ;;
                  90) echo "2024-08" ;;
                  93) echo "2024-09" ;;
                  99) echo "2024-10" ;;
                  112) echo "2024-11" ;;
                  115) echo "2024-12" ;;
                  118) echo "2025-01" ;;
                  124) echo "2025-02" ;;
                  128) echo "2025-03" ;;
                  129) echo "2025-04" ;;
                  134) echo "2025-05" ;;
                  138) echo "2025-06" ;;
                  141) echo "2025-07" ;;
                  145) echo "2025-09" ;;
                  *) echo "lts" ;;
                esac
                ;;
              "6.6")
                # Android 15 - 6.6 æ˜ å°„è¡¨
                case "$sl" in
                  30) echo "2024-08" ;;
                  46) echo "2024-09" ;;
                  50) echo "2024-10" ;;
                  56) echo "2024-11" ;;
                  57) echo "2024-12" ;;
                  58) echo "2025-01" ;;
                  66) echo "2025-02" ;;
                  77) echo "2025-03" ;;
                  82) echo "2025-04" ;;
                  87) echo "2025-05" ;;
                  89) echo "2025-06" ;;
                  92) echo "2025-07" ;;
                  98) echo "2025-09" ;;
                  102) echo "2025-10" ;;
                  *) echo "lts" ;;
                esac
                ;;
              "6.12")
                # Android 16 - 6.12 æ˜ å°„è¡¨
                case "$sl" in
                  5) echo "2025-03" ;;
                  8) echo "2025-04" ;;
                  13) echo "2025-05" ;;
                  17) echo "2025-06" ;;
                  22) echo "2025-07" ;;
                  31) echo "2025-09" ;;
                  *) echo "lts" ;;
                esac
                ;;
              *)
                echo "lts"
                ;;
            esac
          }
          
          OS_PATCH_LEVEL=$(get_patch_level "$KERNEL_VER" "$SUB_LEVEL")
          echo "OS_PATCH_LEVEL=$OS_PATCH_LEVEL" >> $GITHUB_ENV
          echo "os_patch_level=$OS_PATCH_LEVEL" >> $GITHUB_OUTPUT
          echo "å†…æ ¸ $KERNEL_VER.$SUB_LEVEL å¯¹åº”å®‰å…¨è¡¥ä¸çº§åˆ«: $OS_PATCH_LEVEL"

      - name: ä¸‹è½½å†…æ ¸æºç 
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          echo "=== ä¸‹è½½å†…æ ¸æºç  ==="
          FORMATTED_BRANCH="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ env.OS_PATCH_LEVEL }}"
          echo "åˆ†æ”¯: common-${FORMATTED_BRANCH}"
          
          $REPO init --depth=1 \
            --u https://android.googlesource.com/kernel/manifest \
            -b "common-${FORMATTED_BRANCH}" \
            --repo-rev=v2.16
          
          # æ£€æŸ¥æ˜¯å¦ä¸º deprecated åˆ†æ”¯
          REMOTE_BRANCH=$(git ls-remote https://android.googlesource.com/kernel/common "${FORMATTED_BRANCH}" 2>/dev/null || true)
          if echo "$REMOTE_BRANCH" | grep -q deprecated; then
            echo "åˆ†æ”¯å·²å¼ƒç”¨ï¼Œæ›´æ–° manifest..."
            sed -i "s/\"${FORMATTED_BRANCH}\"/\"deprecated\/${FORMATTED_BRANCH}\"/g" .repo/manifests/default.xml
          fi
          
          $REPO --trace sync -c -j$(nproc --all) --no-tags --fail-fast
          
          # è·å–å®é™… sublevel (éªŒè¯)
          if [ -f "common/Makefile" ]; then
            ACTUAL_SUBLEVEL=$(grep '^SUBLEVEL = ' common/Makefile | awk '{print $3}')
            echo "SUBLEVEL=$ACTUAL_SUBLEVEL" >> $GITHUB_ENV
            echo "å®é™…å†…æ ¸ç‰ˆæœ¬: ${{ inputs.kernel_version }}.$ACTUAL_SUBLEVEL"
          else
            echo "SUBLEVEL=${{ inputs.sub_level }}" >> $GITHUB_ENV
          fi

      - name: æ¸…ç† ABI ä¿æŠ¤å’Œ dirty åç¼€
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          # ç§»é™¤ ABI ä¿æŠ¤æ–‡ä»¶å’Œ BUILD.bazel ä¸­çš„å¼•ç”¨
          rm -rf common/android/abi_gki_protected_exports_* || true
          perl -pi -e 's/^\s*"protected_exports_list"\s*:\s*"android\/abi_gki_protected_exports_aarch64",\s*$//;' common/BUILD.bazel || true
          
          # ç§»é™¤ dirty åç¼€
          sed -i "/stable_scmversion_cmd/s/-maybe-dirty//g" build/kernel/kleaf/impl/stamp.bzl || true
          sed -i 's/ -dirty//g' common/scripts/setlocalversion || true

      - name: ä¿®æ”¹å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          # ä»æœ¬åœ°é…ç½®æ–‡ä»¶è·å– KMI Generation (ä¼˜å…ˆ)
          KMI_GEN=$(grep -oP 'KMI_GENERATION=\K[0-9]+' common/build.config.constants 2>/dev/null || \
                    grep -oP 'KMI_GENERATION=\K[0-9]+' common/build.config.common 2>/dev/null || \
                    echo "")
          
          # å¦‚æœæœ¬åœ°è·å–å¤±è´¥ï¼Œä» Google æºç è¿œç¨‹è·å–
          if [ -z "$KMI_GEN" ]; then
            BRANCH="${{ inputs.android_version }}-${{ inputs.kernel_version }}"
            KMI_GEN=$(curl -sL "https://android.googlesource.com/kernel/common/+/refs/heads/${BRANCH}/build.config.constants?format=TEXT" 2>/dev/null | \
              base64 -d 2>/dev/null | grep -oP 'KMI_GENERATION=\K[0-9]+' || true)
            
            if [ -z "$KMI_GEN" ]; then
              KMI_GEN=$(curl -sL "https://android.googlesource.com/kernel/common/+/refs/heads/${BRANCH}/build.config.common?format=TEXT" 2>/dev/null | \
                base64 -d 2>/dev/null | grep -oP 'KMI_GENERATION=\K[0-9]+' || echo "0")
            fi
          fi
          
          echo "KMI_GEN=$KMI_GEN" >> $GITHUB_ENV
          
          FULL_SUFFIX="${{ inputs.android_version }}-${KMI_GEN}-${{ inputs.kernel_suffix }}"
          echo "å†…æ ¸åç¼€: -${FULL_SUFFIX} (KMI Generation: ${KMI_GEN})"
          sed -i "\$s|echo \"\\\$res\"|echo \"-${FULL_SUFFIX}\"|" ./common/scripts/setlocalversion
          
          BUILD_TIMESTAMP=$(date -u -d "${{ inputs.build_time }}" +%s 2>/dev/null || echo "1749578348")
          [ -f "./build/kernel/kleaf/impl/stamp.bzl" ] && \
            sed -i "s/SOURCE_DATE_EPOCH=0/SOURCE_DATE_EPOCH=$BUILD_TIMESTAMP/" ./build/kernel/kleaf/impl/stamp.bzl || true

      # ==================== æ·»åŠ  KernelSU ====================
      - name: æ·»åŠ  KernelSU
        id: ksu_version
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          echo "=== æ·»åŠ  KernelSU (${{ inputs.ksu_type }}) ===="
          
          case "${{ inputs.ksu_type }}" in
            sukisu)
              echo "é…ç½® SukiSU Ultra..."
              curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/main/kernel/setup.sh" | bash -s builtin
              cd KernelSU
              
              # è·å–å½“å‰ Git æäº¤çš„çŸ­å“ˆå¸Œ (8ä½)
              GIT_HASH=$(git rev-parse --short=8 HEAD)
              echo "å½“å‰æäº¤å“ˆå¸Œ: $GIT_HASH"
              
              # å°è¯•æœ€å¤š 3 æ¬¡è·å– KernelSU API ç‰ˆæœ¬å· (ä» Kbuild è·å–)
              for i in {1..3}; do
                KSU_API=$(curl -s "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/builtin/kernel/Kbuild" | \
                  grep -m1 "KSU_VERSION_API :=" | awk -F'= ' '{print $2}' | tr -d '[:space:]')
                [ -n "$KSU_API" ] && break || sleep 1
              done
              [ -z "$KSU_API" ] && KSU_API="4.0.0"
              
              # åˆ›å»ºç‰ˆæœ¬å®šä¹‰æ¨¡æ¿
              VERSION_DEFINITIONS=$'define get_ksu_version_full\nv\\$1-'"$GIT_HASH"$'@amuae\nendef\n\nKSU_VERSION_API := '"$KSU_API"$'\nKSU_VERSION_FULL := v'"$KSU_API"$'-'"$GIT_HASH"$'@amuae'
              
              # æ¸…ç† Kbuild ä¸­çš„æ—§ç‰ˆæœ¬å®šä¹‰
              sed -i '/define get_ksu_version_full/,/endef/d' kernel/Kbuild
              sed -i '/KSU_VERSION_API :=/d' kernel/Kbuild
              sed -i '/KSU_VERSION_FULL :=/d' kernel/Kbuild
              
              # åœ¨ REPO_OWNER è¡Œåæ’å…¥æ–°ç‰ˆæœ¬å®šä¹‰
              awk -v def="$VERSION_DEFINITIONS" '
                /REPO_OWNER :=/ {print; print def; inserted=1; next}
                1
                END {if (!inserted) print def}
              ' kernel/Kbuild > kernel/Kbuild.tmp && mv kernel/Kbuild.tmp kernel/Kbuild
              
              # ç”Ÿæˆè‡ªå®šä¹‰ç‰ˆæœ¬å·
              KSU_VERSION=$(expr $(git rev-list --count main 2>/dev/null || echo 0) + 37185)
              
              # éªŒè¯ä¿®æ”¹ç»“æœ
              grep -A10 "REPO_OWNER" kernel/Kbuild
              echo "SukiSU ç‰ˆæœ¬: v$KSU_API-$GIT_HASH@amuae ($KSU_VERSION)"
              ;;
              
            ksunext)
              echo "é…ç½® KernelSU Next..."
              curl -LSs "https://raw.githubusercontent.com/pershoot/KernelSU-Next/next-susfs/kernel/setup.sh" | bash -s next-susfs
              cd KernelSU-Next
              KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/pershoot/KernelSU-Next/commits?sha=next&per_page=1" | \
                grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') + 10200)
              sed -i "s/DKSU_VERSION=11998/DKSU_VERSION=${KSU_VERSION}/" kernel/Makefile
              ;;
              
            mksu)
              echo "é…ç½® MKSU (5ec1cff)..."
              curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/main/kernel/setup.sh" | bash -s main
              cd KernelSU
              KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/5ec1cff/KernelSU/commits?sha=main&per_page=1" | \
                grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') + 30000)
              sed -i "s/DKSU_VERSION=16/DKSU_VERSION=${KSU_VERSION}/" kernel/Kbuild
              ;;
              
            ksu)
              echo "é…ç½®åŸç‰ˆ KernelSU..."
              curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
              cd KernelSU
              KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/tiann/KernelSU/commits?sha=main&per_page=1" | \
                grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') + 30000)
              sed -i "s/DKSU_VERSION=16/DKSU_VERSION=${KSU_VERSION}/" kernel/Kbuild
              ;;
          esac
          
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT

      # ==================== åº”ç”¨ SUSFS è¡¥ä¸ ====================
      - name: åº”ç”¨ SUSFS è¡¥ä¸
        if: env.SUSFS_ENABLE == 'true'
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          echo "=== åº”ç”¨ SUSFS è¡¥ä¸ ==="
          
          case "${{ inputs.ksu_type }}" in
            sukisu)
              git clone https://github.com/ShirkNeko/susfs4ksu.git -b gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}
              git clone https://github.com/ShirkNeko/SukiSU_patch.git
              
              cp susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch common/
              cp susfs4ksu/kernel_patches/fs/* common/fs/
              cp susfs4ksu/kernel_patches/include/linux/* common/include/linux/
              cp SukiSU_patch/69_hide_stuff.patch common/
              
              cd common
              patch -p1 < 50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch || true
              patch -p1 < 69_hide_stuff.patch || true
              ;;
              
            ksunext)
              git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}
              cd susfs4ksu && git checkout a162e2469d0b472545e5e46457eee171c0975fb0 && cd ..
              git clone https://github.com/WildKernels/kernel_patches.git
              
              cp susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch common/
              cp susfs4ksu/kernel_patches/fs/* common/fs/
              cp susfs4ksu/kernel_patches/include/linux/* common/include/linux/
              cp kernel_patches/next/scope_min_manual_hooks_v1.5.patch common/
              cp kernel_patches/69_hide_stuff.patch common/
              
              cd common
              patch -p1 < 50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch || true
              patch -p1 -N -F 3 < scope_min_manual_hooks_v1.5.patch || true
              patch -p1 -N -F 3 < 69_hide_stuff.patch || true
              
              # æ·»åŠ  WildKSU ç®¡ç†å™¨æ”¯æŒ
              cd drivers/kernelsu
              wget -q https://github.com/WildKernels/kernel_patches/raw/main/next/susfs_fix_patches/v1.5.12/fix_apk_sign.c.patch
              patch -p2 -N -F 3 < fix_apk_sign.c.patch || true
              ;;
              
            mksu|ksu)
              git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}
              git clone https://github.com/ShirkNeko/SukiSU_patch.git
              
              cp susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch KernelSU/
              cp susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch common/
              cp susfs4ksu/kernel_patches/fs/* common/fs/
              cp susfs4ksu/kernel_patches/include/linux/* common/include/linux/
              cp SukiSU_patch/69_hide_stuff.patch common/
              
              cd KernelSU
              patch -p1 < 10_enable_susfs_for_ksu.patch || true
              
              if [ "${{ inputs.ksu_type }}" == "mksu" ]; then
                wget -q https://github.com/cctv18/oppo_oplus_realme_sm8650/raw/main/other_patch/mksu_supercalls.patch
                patch -p1 < mksu_supercalls.patch || true
              fi
              wget -q https://github.com/cctv18/oppo_oplus_realme_sm8650/raw/main/other_patch/fix_umount.patch
              patch -p1 < fix_umount.patch || true
              
              cd ../common
              patch -p1 < 50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch || true
              patch -p1 -N -F 3 < 69_hide_stuff.patch || true
              ;;
          esac

      # ==================== åº”ç”¨æ€§èƒ½è¡¥ä¸ ====================
      - name: å…‹éš†è¡¥ä¸ä»“åº“
        run: |
          git clone https://github.com/WildKernels/kernel_patches.git --depth=1 || true

      - name: åº”ç”¨æ€§èƒ½ä¼˜åŒ–è¡¥ä¸
        working-directory: ${{ env.KERNEL_ROOT }}/common
        run: |
          echo "=== åº”ç”¨æ€§èƒ½ä¼˜åŒ–è¡¥ä¸ ==="
          PATCHES_DIR="$ROOT/kernel_patches/common"
          
          # å†…å­˜ä¼˜åŒ–
          [ -f "$PATCHES_DIR/optimized_mem_operations.patch" ] && \
            patch -p1 --forward < "$PATCHES_DIR/optimized_mem_operations.patch" || true
          
          # æ–‡ä»¶ç»“æ„å¯¹é½
          [ -f "$PATCHES_DIR/file_struct_8bytes_align.patch" ] && \
            patch -p1 --forward < "$PATCHES_DIR/file_struct_8bytes_align.patch" || true
          
          # ç¼“å­˜å‹åŠ›ä¼˜åŒ–
          [ -f "$PATCHES_DIR/reduce_cache_pressure.patch" ] && \
            patch -p1 --forward < "$PATCHES_DIR/reduce_cache_pressure.patch" || true
          
          # é¡µé¢æ¸…é™¤ä¼˜åŒ–
          if [ -f "$PATCHES_DIR/clear_page_16bytes_align.patch" ]; then
            if [ "$(printf '%s\n' "${{ inputs.kernel_version }}" "5.16" | sort -V | head -n1)" = "${{ inputs.kernel_version }}" ]; then
              patch -p1 --forward < "$PATCHES_DIR/clear_page_16bytes_align.patch" || true
            else
              sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' \
                "$PATCHES_DIR/clear_page_16bytes_align.patch" > clear_page_pi.patch
              patch -p1 -F3 --forward < clear_page_pi.patch || true
            fi
          fi
          
          echo "æ€§èƒ½ä¼˜åŒ–è¡¥ä¸åº”ç”¨å®Œæˆ"

      - name: åº”ç”¨ LZ4KD å‹ç¼©è¡¥ä¸
        if: env.LZ4KD_ENABLE == 'true'
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          echo "=== åº”ç”¨ LZ4KD è¡¥ä¸ ==="
          if [ ! -d "SukiSU_patch" ]; then
            git clone https://github.com/ShirkNeko/SukiSU_patch.git
          fi
          
          cd common
          cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./include/linux/
          cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./lib/
          cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./crypto/
          cp ../SukiSU_patch/other/zram/zram_patch/${{ inputs.kernel_version }}/lz4kd.patch ./
          patch -p1 -F 3 < lz4kd.patch || true

      # ==================== æ·»åŠ å†…æ ¸åŠŸèƒ½ ====================
      - name: æ·»åŠ  BBG åŸºå¸¦ä¿æŠ¤
        if: env.BBG_ENABLE == 'true'
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          echo "=== æ·»åŠ  BBG åŸºå¸¦ä¿æŠ¤ ==="
          echo "CONFIG_BBG=y" >> "${{ env.DEFCONFIG }}"
          
          cd common/security
          wget -q https://github.com/cctv18/Baseband-guard/archive/refs/heads/master.zip
          unzip -q master.zip
          mv Baseband-guard-master baseband-guard
          
          echo 'obj-$(CONFIG_BBG) += baseband-guard/' >> Makefile
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' Kconfig
          
          awk '
          /endmenu/ { last_endmenu_line = NR }
          { lines[NR] = $0 }
          END {
            for (i=1; i<=NR; i++) {
              if (i == last_endmenu_line) {
                sub(/endmenu/, "", lines[i]);
                print lines[i] "source \"security/baseband-guard/Kconfig\""
                print ""
                print "endmenu"
              } else {
                print lines[i]
              }
            }
          }' Kconfig > Kconfig.tmp && mv Kconfig.tmp Kconfig
          
          sed -i 's/selinuxfs.o //g' selinux/Makefile
          sed -i 's/hooks.o //g' selinux/Makefile
          cat baseband-guard/sepatch.txt >> selinux/Makefile

      - name: æ·»åŠ  Re-Kernel æ”¯æŒ
        if: env.REKERNEL_ENABLE == 'true'
        working-directory: ${{ env.KERNEL_ROOT }}/common
        run: |
          echo "=== æ·»åŠ  Re-Kernel æ”¯æŒ ==="
          echo "CONFIG_RE_KERNEL=y" >> "${{ env.DEFCONFIG }}"
          
          curl -LSs "https://raw.githubusercontent.com/AuroraNova6/ReKernel/main/kernel/re_kernel.c" -o kernel/re_kernel.c
          echo "obj-\$(CONFIG_RE_KERNEL) += re_kernel.o" >> kernel/Makefile
          
          # æ·»åŠ  Kconfig
          echo "" >> kernel/Kconfig
          echo "config RE_KERNEL" >> kernel/Kconfig
          echo "    bool \"Re-Kernel support for enhanced app freezing\"" >> kernel/Kconfig
          echo "    default n" >> kernel/Kconfig
          echo "    help" >> kernel/Kconfig
          echo "      Enable Re-Kernel support for enhanced application freezing capabilities." >> kernel/Kconfig

      # ==================== é…ç½®å†…æ ¸ ====================
      - name: é…ç½®å†…æ ¸é€‰é¡¹
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          echo "=== é…ç½®å†…æ ¸é€‰é¡¹ ==="
          DEFCONFIG="${{ env.DEFCONFIG }}"
          
          # KernelSU é…ç½®
          echo "" >> "$DEFCONFIG"
          echo "# KernelSU Configuration" >> "$DEFCONFIG"
          echo "CONFIG_KSU=y" >> "$DEFCONFIG"
          
          # KPM æ”¯æŒ (ä»… SukiSU)
          if [[ "$KPM_ENABLE" == "true" && "${{ inputs.ksu_type }}" == "sukisu" ]]; then
            echo "CONFIG_KPM=y" >> "$DEFCONFIG"
          fi
          
          # SUSFS é…ç½®
          if [ "$SUSFS_ENABLE" == "true" ]; then
            echo "" >> "$DEFCONFIG"
            echo "# SUSFS Configuration" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> "$DEFCONFIG"
          else
            echo "CONFIG_KSU_SUSFS=n" >> "$DEFCONFIG"
          fi
          
          # Mountify æ”¯æŒ
          echo "" >> "$DEFCONFIG"
          echo "# Mountify Support" >> "$DEFCONFIG"
          echo "CONFIG_TMPFS_XATTR=y" >> "$DEFCONFIG"
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> "$DEFCONFIG"
          
          # ç½‘ç»œé…ç½®
          echo "" >> "$DEFCONFIG"
          echo "# Networking" >> "$DEFCONFIG"
          echo "CONFIG_IP_NF_TARGET_TTL=y" >> "$DEFCONFIG"
          echo "CONFIG_IP6_NF_TARGET_HL=y" >> "$DEFCONFIG"
          echo "CONFIG_IP6_NF_MATCH_HL=y" >> "$DEFCONFIG"
          
          # Wireguard
          if [ "${{ env.WIREGUARD_ENABLE }}" == "true" ]; then
            echo "" >> "$DEFCONFIG"
            echo "# Wireguard VPN" >> "$DEFCONFIG"
            echo "CONFIG_WIREGUARD=y" >> "$DEFCONFIG"
          fi
          
          # IPSet æ”¯æŒ (åŒ…å« TPROXY ç­‰ netfilter æ‰©å±•)
          if [ "${{ env.IPSET_ENABLE }}" == "true" ]; then
            echo "" >> "$DEFCONFIG"
            echo "# IPSet and Netfilter Extensions (for tproxy.sh)" >> "$DEFCONFIG"
            # TPROXY é€æ˜ä»£ç†æ”¯æŒ
            echo "CONFIG_NETFILTER_TPROXY=y" >> "$DEFCONFIG"
            echo "CONFIG_NETFILTER_XT_TARGET_TPROXY=y" >> "$DEFCONFIG"
            # Netfilter åŒ¹é…æ‰©å±•
            echo "CONFIG_NETFILTER_XT_SET=y" >> "$DEFCONFIG"
            echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y" >> "$DEFCONFIG"
            echo "CONFIG_NETFILTER_XT_MATCH_MARK=y" >> "$DEFCONFIG"
            echo "CONFIG_NETFILTER_XT_TARGET_MARK=y" >> "$DEFCONFIG"
            echo "CONFIG_NETFILTER_XT_MATCH_OWNER=y" >> "$DEFCONFIG"
            echo "CONFIG_NETFILTER_XT_MATCH_MAC=y" >> "$DEFCONFIG"
            # IPSet æ ¸å¿ƒ
            echo "CONFIG_IP_SET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_MAX=65534" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_BITMAP_IP=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_BITMAP_IPMAC=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_BITMAP_PORT=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IP=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPMARK=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPPORT=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPPORTIP=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPPORTNET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPMAC=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_MAC=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETPORTNET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETNET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETPORT=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETIFACE=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_LIST_SET=y" >> "$DEFCONFIG"
            # IPv6 NAT
            echo "CONFIG_IP6_NF_NAT=y" >> "$DEFCONFIG"
            echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y" >> "$DEFCONFIG"
            echo "CONFIG_IP6_NF_TARGET_REDIRECT=y" >> "$DEFCONFIG"
          fi
          
          # LZ4KD é…ç½®
          if [ "${{ env.LZ4KD_ENABLE }}" == "true" ]; then
            echo "" >> "$DEFCONFIG"
            echo "# LZ4KD Compression" >> "$DEFCONFIG"
            echo "CONFIG_ZSMALLOC=y" >> "$DEFCONFIG"
            echo "CONFIG_CRYPTO_LZ4HC=y" >> "$DEFCONFIG"
            echo "CONFIG_CRYPTO_LZ4K=y" >> "$DEFCONFIG"
            echo "CONFIG_CRYPTO_LZ4KD=y" >> "$DEFCONFIG"
            echo "CONFIG_CRYPTO_842=y" >> "$DEFCONFIG"
          fi
          
          # ç¼–è¯‘ä¼˜åŒ–
          echo "" >> "$DEFCONFIG"
          echo "# Build Optimization" >> "$DEFCONFIG"
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> "$DEFCONFIG"
          echo "CONFIG_HEADERS_INSTALL=n" >> "$DEFCONFIG"
          
          # ç¦ç”¨ defconfig æ£€æŸ¥
          sed -i 's/check_defconfig//' common/build.config.gki || true
          
          echo "å†…æ ¸é…ç½®å®Œæˆ"

      # ==================== æ„å»ºå†…æ ¸ ====================
      - name: æ„å»ºå†…æ ¸
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          echo "=== å¼€å§‹æ„å»ºå†…æ ¸ ==="
          
          # æ„å»º (Bazel æœ‰è‡ªå·±çš„ç¼“å­˜ç³»ç»Ÿï¼Œæ— éœ€ ccache)
          if [ -f "build/build.sh" ]; then
            LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh
          else
            tools/bazel build --config=fast --config=stamp --lto=thin //common:kernel_aarch64_dist
          fi
          
          echo "å†…æ ¸æ„å»ºå®Œæˆ"

      # KPM åå¤„ç† (ä»…å¯¹ SukiSU + KPM ç”Ÿæ•ˆ)
      - name: åº”ç”¨ KPM è¡¥ä¸
        if: inputs.ksu_type == 'sukisu' && env.KPM_ENABLE == 'true'
        run: |
          echo "=== åº”ç”¨ KPM è¡¥ä¸ ==="
          cd $KERNEL_ROOT
          
          # æ‰¾åˆ° Image æ–‡ä»¶ä½ç½®
          if [ -f "out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image" ]; then
            IMAGE_DIR="out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist"
          elif [ -f "bazel-bin/common/kernel_aarch64/Image" ]; then
            IMAGE_DIR="bazel-bin/common/kernel_aarch64"
          else
            echo "é”™è¯¯: æ‰¾ä¸åˆ° Image æ–‡ä»¶"
            exit 1
          fi
          
          cd "$IMAGE_DIR"
          curl -LO https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch/releases/latest/download/patch_linux
          chmod +x patch_linux
          ./patch_linux
          rm -f Image
          mv oImage Image
          echo "KPM è¡¥ä¸åº”ç”¨å®Œæˆ"

      # ==================== æ‰“åŒ… ====================
      - name: æ‰“åŒ…å†…æ ¸
        run: |
          echo "=== æ‰“åŒ…å†…æ ¸ ==="
          
          # æŸ¥æ‰¾ Image æ–‡ä»¶
          if [ -f "$KERNEL_ROOT/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image" ]; then
            IMAGE_PATH="$KERNEL_ROOT/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image"
          elif [ -f "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" ]; then
            IMAGE_PATH="$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image"
          else
            echo "é”™è¯¯: æ‰¾ä¸åˆ° Image æ–‡ä»¶"
            find $KERNEL_ROOT -name "Image" -type f 2>/dev/null || true
            exit 1
          fi
          
          # å¤åˆ¶ Image åˆ°å·¥ä½œç›®å½•å¹¶é‡å‘½å
          IMAGE_NAME="${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}-${{ inputs.android_version }}-${{ inputs.ksu_type }}-Image"
          cp "$IMAGE_PATH" "./$IMAGE_NAME"
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          
          # å¤åˆ¶åˆ° AnyKernel3 å¹¶æ‰“åŒ…
          cp "$IMAGE_PATH" AnyKernel3/Image
          
          # åˆ›å»º ZIP
          cd AnyKernel3
          ZIP_NAME="${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}-${{ inputs.android_version }}-${{ inputs.ksu_type }}-AnyKernel3.zip"
          zip -r9 "../$ZIP_NAME" * -x .git .gitignore README.md
          
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "æ‰“åŒ…å®Œæˆ: $ZIP_NAME"

      # ==================== ä¸Šä¼  ====================
      - name: ä¸Šä¼  Image
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.IMAGE_NAME }}
          path: ${{ env.IMAGE_NAME }}
          compression-level: 0

      - name: ä¸Šä¼  AnyKernel3
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}
          compression-level: 0

      - name: åˆ›å»º Release
        if: inputs.create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}-${{ github.run_number }}
          name: "GKI ${{ inputs.android_version }} å†…æ ¸ ${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}"
          body: |
            ## æ„å»ºä¿¡æ¯
            - **Android ç‰ˆæœ¬**: ${{ inputs.android_version }}
            - **å†…æ ¸ç‰ˆæœ¬**: ${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}
            - **KernelSU**: ${{ inputs.ksu_type }} (v${{ env.KSUVER }})
            - **SUSFS**: âœ… å¯ç”¨
            - **KPM**: ${{ env.KPM_ENABLE == 'true' && 'âœ… å¯ç”¨' || 'âŒ ç¦ç”¨' }}
          files: |
            ${{ env.IMAGE_NAME }}
            ${{ env.ZIP_NAME }}
          draft: false
          prerelease: false

      # ==================== Telegram é€šçŸ¥ ====================
      - name: å‘é€ Telegram é€šçŸ¥
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram é…ç½®æœªè®¾ç½®ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          # KPM çŠ¶æ€æ–‡æœ¬
          if [[ "${{ env.KPM_ENABLE }}" == "true" ]]; then
            KPM_STATUS="âœ… å¯ç”¨"
          else
            KPM_STATUS="âŒ ç¦ç”¨"
          fi
          
          # æ„å»ºä¿¡æ¯ (ä½¿ç”¨ heredoc é¿å…ç¼©è¿›é—®é¢˜)
          BUILD_INFO=$(cat << EOF
          ğŸŒ½ *GKI å†…æ ¸æ„å»ºæˆåŠŸ*
          
          ğŸ“± *Android*: ${{ inputs.android_version }}
          ğŸ”¢ *å†…æ ¸å*: ${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}-${{ inputs.android_version }}-${{ env.KMI_GEN }}-${{ inputs.kernel_suffix }}
          ğŸ• *å†…æ ¸æ—¶é—´*: ${{ inputs.build_time }}
          ğŸ”§ *KernelSU*: ${{ inputs.ksu_type }} (v${{ env.KSUVER }})
          ğŸ”’ *SUSFS*: âœ… å¯ç”¨
          âš¡ *KPM*: ${KPM_STATUS}
          
          ğŸ”— [æŸ¥çœ‹ Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          )

          # å‘é€ AnyKernel3 åŒ…
          if [ -f "${{ env.ZIP_NAME }}" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
              -F chat_id="${TELEGRAM_CHAT_ID}" \
              -F document=@"${{ env.ZIP_NAME }}" \
              -F caption="${BUILD_INFO}" \
              -F parse_mode="Markdown"
          else
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ï¼Œåªå‘é€æ¶ˆæ¯
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="${BUILD_INFO}" \
              -d parse_mode="Markdown"
          fi
