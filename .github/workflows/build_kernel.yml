name: Build GKI Kernel (SukiSU+SUSFS)

permissions:
  contents: write
  actions: write

on:
  push:
    branches:
      - sukisu
    paths:
      - '.github/workflows/build_kernel.yml'
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Androidç‰ˆæœ¬'
        required: true
        default: 'android14'
        type: choice
        options:
          - android14
          - android15
      kernel_version:
        description: 'å†…æ ¸ç‰ˆæœ¬'
        required: true
        default: '6.1'
        type: choice
        options:
          - '5.15'
          - '6.1'
          - '6.6'
      os_patch_level:
        description: 'å®‰å…¨è¡¥ä¸ (YYYY-MM)'
        required: true
        default: '2025-01'
        type: string
      hook_method:
        description: 'Hookæ–¹æ³•'
        required: true
        default: 'manual'
        type: choice
        options:
          - manual
          - syscall
          - kprobes
      enable_bbg:
        description: 'BBGåŸºå¸¦ä¿æŠ¤'
        required: false
        default: true
        type: boolean
      enable_ipset:
        description: 'IPSetæ”¯æŒ'
        required: false
        default: true
        type: boolean
      module_bypass:
        description: 'æ¨¡å—ç»•è¿‡'
        required: false
        default: false
        type: boolean
      create_release:
        description: 'å‘å¸ƒRelease'
        required: false
        default: false
        type: boolean
      kernel_name:
        description: 'å†…æ ¸åç§°åç¼€'
        required: false
        default: 'gca0ef6d17716-ab13624819'
        type: string
      build_time:
        description: 'æ„å»ºæ—¶é—´'
        required: false
        default: 'Tue Jun 10 18:59:08 UTC 2025'
        type: string

jobs:
  build:
    name: æ„å»ºå†…æ ¸
    runs-on: ubuntu-22.04
    
    steps:
      - name: é…ç½®æ„å»ºç¯å¢ƒ
        run: |
          echo "=== é…ç½®æ„å»ºç¯å¢ƒ ==="
          sudo apt-get update -qq
          sudo apt-get install -y -qq git curl wget build-essential bc bison flex libssl-dev libelf-dev zip python3 python3-pip rsync >/dev/null 2>&1
          
          # å®‰è£… repo å·¥å…·
          mkdir -p ~/bin
          curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+rx ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH
          
          # å¼ºåˆ¶ä½¿ç”¨ IPv4
          git config --global url."https://github.com/".insteadOf "git://github.com/"
          git config --global http.version HTTP/1.1
          
          echo "ç¯å¢ƒé…ç½®å®Œæˆ"
      
      - name: ä¸‹è½½å†…æ ¸æºç 
        run: |
          echo "=== ä¸‹è½½å†…æ ¸æºç  ==="
          
          # Determine sublevel
          case "${{ inputs.kernel_version }}" in
            "5.15") SUBLEVEL="119" ;;
            "6.1")  SUBLEVEL="118" ;;
            "6.6")  SUBLEVEL="65" ;;
            *)      SUBLEVEL="118" ;;
          esac
          
          FORMATTED_BRANCH="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.os_patch_level }}"
          SOURCE_DIR="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${SUBLEVEL}"
          
          echo "Branch: common-${FORMATTED_BRANCH}"
          echo "Source Dir: ${SOURCE_DIR}"
          
          mkdir -p "${SOURCE_DIR}"
          cd "${SOURCE_DIR}"
          
          ~/bin/repo init --depth=1 \
            --u https://android.googlesource.com/kernel/manifest \
            -b "common-${FORMATTED_BRANCH}" \
            --repo-rev=v2.16
          
          REMOTE_BRANCH=$(git ls-remote https://android.googlesource.com/kernel/common "${FORMATTED_BRANCH}" 2>/dev/null || true)
          if echo "$REMOTE_BRANCH" | grep -q deprecated; then
            echo "Branch is deprecated, updating manifest..."
            sed -i "s/\"${FORMATTED_BRANCH}\"/\"deprecated\/${FORMATTED_BRANCH}\"/g" .repo/manifests/default.xml
          fi
          
          CPU_COUNT=$(nproc)
          echo "Syncing with ${CPU_COUNT} parallel jobs..."
          ~/bin/repo sync -c -j"${CPU_COUNT}" --no-tags --fail-fast
          
          if [ -f "common/Makefile" ]; then
            ACTUAL_SUBLEVEL=$(grep '^SUBLEVEL = ' common/Makefile | awk '{print $3}' || echo "${SUBLEVEL}")
            if [ -n "$ACTUAL_SUBLEVEL" ]; then
              SUBLEVEL="$ACTUAL_SUBLEVEL"
            fi
          fi
          
          echo "Kernel version: ${{ inputs.kernel_version }}.${SUBLEVEL}"
          cd ..
          
          echo "SOURCE_DIR=${SOURCE_DIR}" >> $GITHUB_ENV
          echo "SUBLEVEL=${SUBLEVEL}" >> $GITHUB_ENV
      
      - name: é›†æˆ SukiSU
        run: |
          echo "=== é›†æˆ SukiSU ==="
          cd "${{ env.SOURCE_DIR }}"
          
          curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/refs/heads/main/kernel/setup.sh" | bash -s susfs-main
          
          cd ./KernelSU
          
          GIT_COMMIT_HASH=$(git rev-parse --short=8 HEAD)
          echo "Current commit hash: $GIT_COMMIT_HASH"
          
          # Calculate KSU version number first
          KSU_VERSION=$(git rev-list --count main 2>/dev/null || echo 0)
          if [ "$KSU_VERSION" != "0" ]; then
            KSU_VERSION=$((KSU_VERSION + 37185))
          else
            KSU_VERSION=114514
          fi
          echo "[OK] KSU version number: $KSU_VERSION"
          
          # Get API version
          KSU_API_VERSION=""
          for i in {1..3}; do
            KSU_API_VERSION=$(curl -s "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/susfs-main/kernel/Makefile" | \
              grep -m1 "KSU_VERSION_API :=" | \
              awk -F'= ' '{print $2}' | \
              tr -d '[:space:]' || echo "")
            if [ -n "$KSU_API_VERSION" ]; then
              break
            fi
            sleep 1
          done
          
          if [ -z "$KSU_API_VERSION" ]; then
            KSU_API_VERSION="3.1.7"
            echo "[WARN] Cannot fetch remote API version, using default: $KSU_API_VERSION"
          else
            echo "[OK] KSU API version: $KSU_API_VERSION"
          fi
          
          # Clean up old version definitions
          sed -i '/define get_ksu_version_full/,/endef/d' kernel/Makefile || true
          sed -i '/KSU_VERSION :=/d' kernel/Makefile || true
          sed -i '/KSU_VERSION_API :=/d' kernel/Makefile || true
          sed -i '/KSU_VERSION_FULL :=/d' kernel/Makefile || true
          sed -i '/ccflags-y += -DKSU_VERSION=/d' kernel/Makefile || true
          sed -i '/ccflags-y += -DKSU_VERSION_FULL=/d' kernel/Makefile || true
          
          # Write version information to Makefile
          echo "" >> kernel/Makefile
          echo "KSU_VERSION := ${KSU_VERSION}" >> kernel/Makefile
          echo "KSU_VERSION_API := ${KSU_API_VERSION}" >> kernel/Makefile
          echo "" >> kernel/Makefile
          echo "define get_ksu_version_full" >> kernel/Makefile
          echo "v\$(KSU_VERSION_API)-${GIT_COMMIT_HASH}@main_test" >> kernel/Makefile
          echo "endef" >> kernel/Makefile
          echo "" >> kernel/Makefile
          echo "KSU_VERSION_FULL := \$(call get_ksu_version_full)" >> kernel/Makefile
          echo "" >> kernel/Makefile
          echo "ccflags-y += -DKSU_VERSION=\$(KSU_VERSION)" >> kernel/Makefile
          echo "ccflags-y += -DKSU_VERSION_FULL=\\\"\$(KSU_VERSION_FULL)\\\"" >> kernel/Makefile
          
          echo "[OK] SukiSU version: v${KSU_API_VERSION}-${GIT_COMMIT_HASH}@main_test"
          echo "[OK] Makefile updated with version information"
          
          cd ..
      
      - name: åº”ç”¨ SUSFS è¡¥ä¸
        run: |
          echo "=== åº”ç”¨ SUSFS è¡¥ä¸ ==="
          cd "${{ env.SOURCE_DIR }}"
          
          git clone https://github.com/ShirkNeko/susfs4ksu.git -b gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}
          git clone https://github.com/ShirkNeko/SukiSU_patch.git
          
          cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch ./common/
          cp -r ./susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp -r ./susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
          
          cd common
          patch -p1 --fuzz=3 < 50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch || true
          
          # åº”ç”¨ hook è¡¥ä¸ï¼ˆmanual æ¨¡å¼ SukiSU å·²å†…ç½®ï¼Œæ— éœ€é¢å¤–è¡¥ä¸ï¼‰
          if [ "${{ inputs.hook_method }}" == "manual" ]; then
            echo "[INFO] Manual hook mode: SukiSU å·²å†…ç½® hooksï¼Œæ— éœ€åº”ç”¨è¡¥ä¸"
          elif [ "${{ inputs.hook_method }}" == "syscall" ]; then
            echo "[INFO] Applying syscall hooks patch..."
            cp ../SukiSU_patch/hooks/syscall_hooks.patch ./
            patch -p1 -F 3 < syscall_hooks.patch || true
          fi
          
          cp ../SukiSU_patch/69_hide_stuff.patch ./
          patch -p1 -F 3 < 69_hide_stuff.patch || true
          
          cd ..
      
      - name: å…‹éš†æ€§èƒ½è¡¥ä¸ä»“åº“
        run: |
          echo "=== å…‹éš†æ€§èƒ½è¡¥ä¸ä»“åº“ ==="
          git clone https://github.com/WildKernels/kernel_patches.git --depth=1
          ls -la kernel_patches/common/ || echo "Failed to clone kernel_patches"
      
      - name: åº”ç”¨æ€§èƒ½ä¼˜åŒ–è¡¥ä¸
        run: |
          echo "=== åº”ç”¨æ€§èƒ½ä¼˜åŒ–è¡¥ä¸ ==="
          cd "${{ env.SOURCE_DIR }}/common"
          MIN_VERSION="5.16"
          
          # 1. ä¼˜åŒ–å†…å­˜æ“ä½œ
          cp ../../kernel_patches/common/optimized_mem_operations.patch ./
          patch -p1 --forward < optimized_mem_operations.patch || true
          echo "[OK] Applied optimized_mem_operations.patch"
          
          # 2. æ–‡ä»¶ç»“æ„ä½“ 8 å­—èŠ‚å¯¹é½
          cp ../../kernel_patches/common/file_struct_8bytes_align.patch ./
          patch -p1 --forward < file_struct_8bytes_align.patch || true
          echo "[OK] Applied file_struct_8bytes_align.patch"
          
          # 3. é™ä½ç¼“å­˜å‹åŠ›
          cp ../../kernel_patches/common/reduce_cache_pressure.patch ./
          patch -p1 --forward < reduce_cache_pressure.patch || true
          echo "[OK] Applied reduce_cache_pressure.patch"
          
          # 4. æ¸…é™¤é¡µé¢ 16 å­—èŠ‚å¯¹é½ï¼ˆå†…æ ¸ç‰ˆæœ¬æ£€æµ‹ï¼‰
          CURRENT_VERSION="${{ inputs.kernel_version }}"
          if [ "$(printf '%s\n' "$CURRENT_VERSION" "$MIN_VERSION" | sort -V | head -n1)" = "$CURRENT_VERSION" ]; then
            echo "Kernel $CURRENT_VERSION < $MIN_VERSION, using original patch"
            cp ../../kernel_patches/common/clear_page_16bytes_align.patch ./
            patch -p1 --forward < clear_page_16bytes_align.patch || true
            echo "[OK] Applied clear_page_16bytes_align.patch"
          else
            echo "Kernel $CURRENT_VERSION >= $MIN_VERSION, using __pi variant"
            cp ../../kernel_patches/common/clear_page_16bytes_align.patch ./
            sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' clear_page_16bytes_align.patch > clear_page_16bytes_align__pi.patch
            patch -p1 -F3 --forward < clear_page_16bytes_align__pi.patch || true
            echo "[OK] Applied clear_page_16bytes_align__pi.patch"
          fi
          
          cd ..
      
      - name: åº”ç”¨é¢å¤–è¡¥ä¸
        run: |
          echo "=== åº”ç”¨é¢å¤–è¡¥ä¸ ==="
          cd "${{ env.SOURCE_DIR }}/common"
          
          wget -q https://github.com/cctv18/oppo_oplus_realme_sm8650/raw/refs/heads/main/other_patch/config.patch || true
          if [ -f "config.patch" ]; then
            patch -p1 -F 3 < config.patch || true
            echo "[OK] config.patch applied"
          fi
          
          cd ..
      
      - name: ä¿®å¤ Samsung 6.6 GKI è®¾å¤‡ WiFi å’Œè“ç‰™
        if: ${{ inputs.kernel_version == '6.6' }}
        run: |
          echo "=== ä¿®å¤ Samsung 6.6 WiFi/BT ==="
          cd "${{ env.SOURCE_DIR }}"
          
          # æ·»åŠ  KDP ç¬¦å·åˆ° ABI åˆ—è¡¨
          SYMBOL_LIST="common/android/abi_gki_aarch64_galaxy"
          echo "kdp_set_cred_non_rcu" >> "$SYMBOL_LIST"
          echo "kdp_usecount_dec_and_test" >> "$SYMBOL_LIST"
          echo "kdp_usecount_inc" >> "$SYMBOL_LIST"
          echo "[OK] Added KDP symbols to $SYMBOL_LIST"
          
          cd common
          PATCH="../../kernel_patches/samsung/min_kdp/add-min_kdp-symbols.patch"
          if patch -p1 --dry-run < "$PATCH" 2>/dev/null; then
            patch -p1 --no-backup-if-mismatch < "$PATCH"
            echo "[OK] Applied min_kdp symbols patch"
          fi
          
          # æ·»åŠ æœ€å° KDP å®ç°
          cd drivers
          cp "../../../kernel_patches/samsung/min_kdp/min_kdp.c" min_kdp.c
          echo "obj-y += min_kdp.o" >> Makefile
          echo "[OK] Added min_kdp driver for Samsung devices"
          
          cd ../..
      
      - name: æ·»åŠ  Baseband-guard æ”¯æŒ
        if: ${{ inputs.enable_bbg }}
        run: |
          echo "æ›´æ”¹ä¸ºé…ç½®ç›®å½•: ${{ env.SOURCE_DIR }}/common..."
          cd "${{ env.SOURCE_DIR }}/common"
          
          # æ‰‹åŠ¨æ‰§è¡ŒBBGé›†æˆæ­¥éª¤ï¼Œé¿å…setup.shæœ«å°¾çš„awké”™è¯¯
          echo "å…‹éš† Baseband-guard ä»“åº“..."
          git clone https://github.com/vc-teahouse/Baseband-guard.git
          
          echo "åˆ›å»ºç¬¦å·é“¾æ¥..."
          ln -sf Baseband-guard bbg
          
          echo "æ›´æ–° Makefile..."
          echo "obj-\$(CONFIG_BBG) += bbg/" >> Makefile
          
          echo "æ›´æ–° Kconfig..."
          sed -i '/source "security\/Kconfig"/a source "bbg/Kconfig"' Kconfig
          
          echo "ä¿ç•™BBGåŸå§‹Makefileï¼ˆåŒ…å«SELinuxè¡¥ä¸ï¼‰..."
          
          echo "å¯ç”¨ Baseband-guard å†…æ ¸é…ç½®..."
          CONFIG_FILE="arch/arm64/configs/gki_defconfig"
          echo "CONFIG_BBG=y" >> "$CONFIG_FILE"
          
          # å¯¹äº GitHub Actions äº‘ç¼–è¯‘ï¼Œä¿®æ”¹ LSM Kconfig
          echo "ä¿®æ”¹ security/Kconfig ä»¥åŒ…å« baseband_guard..."
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' ./security/Kconfig
          
          echo "Baseband-guard é…ç½®å®Œæˆ"
      
      - name: é…ç½®å†…æ ¸
        run: |
          echo "=== é…ç½®å†…æ ¸ ==="
          cd "${{ env.SOURCE_DIR }}"
          
          DEFCONFIG="./common/arch/arm64/configs/gki_defconfig"
          
          sed -i 's/check_defconfig//' ./common/build.config.gki
          
          echo "Adding kernel configurations..."
          
          # KernelSU Configuration
          echo "" >> "$DEFCONFIG"
          echo "# KernelSU Configuration" >> "$DEFCONFIG"
          echo "CONFIG_KSU=y" >> "$DEFCONFIG"
          # SukiSU ä½¿ç”¨ manual hook æ—¶ä¸éœ€è¦é¢å¤–é…ç½®ï¼ˆå·²å†…ç½®ï¼‰
          # syscall/kprobes éœ€è¦æ˜ç¡®è®¾ç½® CONFIG_KSU_SUSFS_SUS_SU
          if [ "${{ inputs.hook_method }}" != "manual" ]; then
            echo "CONFIG_KSU_SUSFS_SUS_SU=y" >> "$DEFCONFIG"
            if [ "${{ inputs.hook_method }}" == "kprobes" ]; then
              echo "CONFIG_KSU_KPROBES_HOOK=y" >> "$DEFCONFIG"
            fi
          fi
          
          # Mountify Support
          echo "" >> "$DEFCONFIG"
          echo "# Mountify Support" >> "$DEFCONFIG"
          echo "CONFIG_TMPFS_XATTR=y" >> "$DEFCONFIG"
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> "$DEFCONFIG"
          
          # Networking Configuration
          echo "" >> "$DEFCONFIG"
          echo "# Networking Configuration" >> "$DEFCONFIG"
          echo "CONFIG_IP_NF_TARGET_TTL=y" >> "$DEFCONFIG"
          echo "CONFIG_IP6_NF_TARGET_HL=y" >> "$DEFCONFIG"
          echo "CONFIG_IP6_NF_MATCH_HL=y" >> "$DEFCONFIG"
          
          # Wireguard Support (built-in to avoid module_outs complexity)
          echo "" >> "$DEFCONFIG"
          echo "# Wireguard VPN Support" >> "$DEFCONFIG"
          echo "CONFIG_WIREGUARD=y" >> "$DEFCONFIG"
          echo "CONFIG_WIREGUARD_DEBUG=n" >> "$DEFCONFIG"
          
          # IPSet Support (optional)
          if [ "${{ inputs.enable_ipset }}" = "true" ]; then
            echo "" >> "$DEFCONFIG"
            echo "# IPSet Support" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_MAX=65534" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_BITMAP_IP=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_BITMAP_IPMAC=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_BITMAP_PORT=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IP=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPMARK=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPPORT=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPPORTIP=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPPORTNET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPMAC=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_MAC=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETPORTNET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETNET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETPORT=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETIFACE=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_LIST_SET=y" >> "$DEFCONFIG"
          fi
          
          # SUSFS Configuration
          echo "" >> "$DEFCONFIG"
          echo "# SUSFS Configuration" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> "$DEFCONFIG"
          
          # SUS_PATH: 6.6 kernel needs to disable this
          if [ "${{ inputs.kernel_version }}" != "6.6" ]; then
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> "$DEFCONFIG"
          else
            echo "CONFIG_KSU_SUSFS_SUS_PATH=n" >> "$DEFCONFIG"
          fi
          
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> "$DEFCONFIG"
          echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> "$DEFCONFIG"
          
          # Sound Configuration
          echo "" >> "$DEFCONFIG"
          echo "# Sound Configuration" >> "$DEFCONFIG"
          echo "CONFIG_SND=y" >> "$DEFCONFIG"
          echo "CONFIG_SND_DRIVERS=y" >> "$DEFCONFIG"
          echo "CONFIG_SND_PCM=y" >> "$DEFCONFIG"
          echo "CONFIG_SND_TIMER=y" >> "$DEFCONFIG"
          echo "CONFIG_SND_DYNAMIC_MINORS=y" >> "$DEFCONFIG"
          echo "CONFIG_SND_PROC_FS=y" >> "$DEFCONFIG"
          echo "CONFIG_SND_ALOOP=m" >> "$DEFCONFIG"
          
          # LTO Optimization (always enabled)
          echo "" >> "$DEFCONFIG"
          echo "# Build Optimization" >> "$DEFCONFIG"
          echo "CONFIG_LTO_CLANG_THIN=y" >> "$DEFCONFIG"
          echo "CONFIG_LTO_CLANG=y" >> "$DEFCONFIG"
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> "$DEFCONFIG"
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3=n" >> "$DEFCONFIG"
          echo "CONFIG_OPTIMIZE_INLINING=y" >> "$DEFCONFIG"
          
          echo "Configuration complete!"
          
          # Add snd-aloop to modules list
          echo "sound/drivers/snd-aloop.ko" >> common/android/gki_aarch64_modules
          
          if [[ -f common/modules.bzl ]]; then
            if [[ "${{ inputs.android_version }}" == "android14" ]] && [[ "${{ inputs.kernel_version }}" == "6.1" ]] && (( ${{ env.SUBLEVEL }} <= 25 )) && [[ "${{ inputs.os_patch_level }}" != "2023-09" ]]; then
              sed -i '/COMMON_GKI_MODULES_LIST = \[/,/^[[:space:]]*\]/{/^[[:space:]]*\]$/i\    "sound/drivers/snd-aloop.ko",
              }' common/modules.bzl
            else
              sed -i '/_COMMON_GKI_MODULES_LIST = \[/,/^[[:space:]]*\]/{/^[[:space:]]*\]$/i\    "sound/drivers/snd-aloop.ko",
              }' common/modules.bzl
            fi
          fi
          
          # ABI bypass
          perl -i -pe 's/^(\s*)return 1$/$1print("Who Cares? Bypassing Now!")\n$1return 0/g if /if missing_symbols:/../return 1/' build/kernel/abi/check_buildtime_symbol_protection.py
          
          # Module check bypass (optional)
          if [ "${{ inputs.module_bypass }}" = "true" ]; then
            if [[ "${{ inputs.kernel_version }}" == "6.1" ]] || [[ "${{ inputs.kernel_version }}" == "6.6" ]]; then
              TARGET_FILE="common/kernel/module/version.c"
            else
              TARGET_FILE="common/kernel/module.c"
            fi
            
            if [ -f "$TARGET_FILE" ]; then
              sed -i '/bad_version:/{:a;n;/return 0;/{s/return 0;/return 1;/;b};ba}' "$TARGET_FILE"
              echo "[OK] Module check bypass applied"
            fi
          fi
      
      - name: ä¿®æ”¹å†…æ ¸ç‰ˆæœ¬
        run: |
          echo "=== ä¿®æ”¹å†…æ ¸ç‰ˆæœ¬ ==="
          cd "${{ env.SOURCE_DIR }}"
          
          sed -i "\$s|echo \"\\\$res\"|echo \"\\\$res-${{ inputs.kernel_name }}\"|" ./common/scripts/setlocalversion
          
          BUILD_TIMESTAMP=$(date -u -d "${{ inputs.build_time }}" +%s 2>/dev/null || echo "1749492000")
          echo "Build timestamp (epoch): $BUILD_TIMESTAMP"
          
          sed -i "s/export SOURCE_DATE_EPOCH=0/export SOURCE_DATE_EPOCH=$BUILD_TIMESTAMP/" ./build/kernel/kleaf/impl/stamp.bzl
          sed -i "/stable_scmversion_cmd/s/-maybe-dirty//g" ./build/kernel/kleaf/impl/stamp.bzl
          
          rm -rf ./common/android/abi_gki_protected_exports_*
          perl -pi -e 's/^\s*"protected_exports_list"\s*:\s*"android\/abi_gki_protected_exports_aarch64",\s*$//;' ./common/BUILD.bazel
      
      - name: æ„å»ºå†…æ ¸
        run: |
          echo "=== æ„å»ºå†…æ ¸ ==="
          cd "${{ env.SOURCE_DIR }}"
          
          echo "é¢„è®¡è€—æ—¶ 30-60 åˆ†é’Ÿ..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          tools/bazel build --config=fast --lto=thin //common:kernel_aarch64_dist
          
          echo "å®Œæˆæ—¶é—´: $(date)"
      
      - name: æ‰“åŒ…å†…æ ¸
        run: |
          echo "=== æ‰“åŒ…å†…æ ¸ ==="
          cd "${{ env.SOURCE_DIR }}"
          
          BAZEL_BIN="bazel-bin/common/kernel_aarch64"
          IMAGE_FILE="${BAZEL_BIN}/Image"
          
          if [ ! -f "$IMAGE_FILE" ]; then
            echo "Error: Kernel Image not found!"
            exit 1
          fi
          
          # Get kernel release version
          KERNEL_RELEASE=$(cat ${BAZEL_BIN}/include/config/kernel.release | tr '+' '_')
          
          # Clone AnyKernel3 if not exists
          if [ ! -d "$GITHUB_WORKSPACE/AnyKernel3" ]; then
            cd "$GITHUB_WORKSPACE"
            git clone https://github.com/WildKernels/AnyKernel3.git -b gki-2.0
            cd "${{ env.SOURCE_DIR }}"
          fi
          
          # Copy kernel to AnyKernel3 and package
          cp "$IMAGE_FILE" "$GITHUB_WORKSPACE/AnyKernel3/Image"
          cd "$GITHUB_WORKSPACE/AnyKernel3"
          
          ZIP_NAME="AnyKernel3-${KERNEL_RELEASE}.zip"
          zip -r9 "${ZIP_NAME}" * -x .git README.md placeholder
          echo "âœ“ AnyKernel3 package created: ${ZIP_NAME}"
          
          # Set environment variables
          echo "KERNEL_RELEASE=${KERNEL_RELEASE}" >> $GITHUB_ENV
          echo "ZIP_FILE=${ZIP_NAME}" >> $GITHUB_ENV
          
          # Generate artifact name
          ARTIFACT_NAME="${{ inputs.android_version }}-${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}-${{ inputs.os_patch_level }}"
          echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV
          
          # List file for verification
          echo "=== AnyKernel3 package ==="
          ls -lh "${ZIP_NAME}"
      
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-kernel
          path: AnyKernel3/${{ env.ZIP_FILE }}
          compression-level: 0
          if-no-files-found: error
      
      - name: ä¸Šä¼ åˆ° Telegram
        if: ${{ success() }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âš ï¸ Telegram credentials not configured, skipping upload"
            exit 0
          fi
          
          cd "$GITHUB_WORKSPACE"
          
          # Build information caption
          CAPTION="ğŸ‰ å†…æ ¸æ„å»ºå®Œæˆ
          
          ğŸ“¦ æ„å»ºä¿¡æ¯:
          â”œ Android: ${{ inputs.android_version }}
          â”œ å†…æ ¸: ${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}
          â”œ è¡¥ä¸: ${{ inputs.os_patch_level }}
          â”œ Hook: ${{ inputs.hook_method }}
          â”œ BBG: ${{ inputs.enable_bbg }}
          â”œ æ¨¡å—ç»•è¿‡: ${{ inputs.module_bypass }}
          â”” ç‰ˆæœ¬: ${{ env.KERNEL_RELEASE }}
          
          ğŸ”— https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Upload AnyKernel3 package with description
          echo "ğŸ“¦ ä¸Šä¼  AnyKernel3 åŒ…..."
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
            -F "chat_id=${TELEGRAM_CHAT_ID}" \
            -F "document=@AnyKernel3/${{ env.ZIP_FILE }}" \
            -F "caption=${CAPTION}" > /dev/null
          
          echo "âœ… æ–‡ä»¶å·²ä¸Šä¼ åˆ° Telegram"
      
      - name: åˆ›å»ºå‘å¸ƒ
        if: ${{ inputs.create_release }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.os_patch_level }}-${{ github.run_number }}
          name: "GKI ${{ inputs.android_version }} å†…æ ¸ ${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}"
          body: |
            ## GKI å†…æ ¸ with SukiSU + SUSFS
            
            **æ„å»ºä¿¡æ¯:**
            - Android ç‰ˆæœ¬: ${{ inputs.android_version }}
            - å†…æ ¸ç‰ˆæœ¬: ${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}
            - å®‰å…¨è¡¥ä¸: ${{ inputs.os_patch_level }}
            - Hook æ–¹æ³•: ${{ inputs.hook_method }}
            - æ¨¡å—ç»•è¿‡: ${{ inputs.module_bypass }}
            - BBG ä¿æŠ¤: ${{ inputs.enable_bbg }}
            - IPSet æ”¯æŒ: ${{ inputs.enable_ipset }}
            
            **å®‰è£…æ–¹å¼:**
            1. åœ¨ Recovery (TWRP/OrangeFox) ä¸­åˆ·å…¥ AnyKernel3 ZIP
            2. ä» https://github.com/ShirkNeko/SukiSU-Ultra å®‰è£… SukiSU Manager
            3. é‡å¯å¹¶éªŒè¯
          draft: false
          prerelease: false
          files: AnyKernel3/${{ env.ZIP_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}