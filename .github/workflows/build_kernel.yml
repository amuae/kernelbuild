name: 构建 GKI 内核

permissions:
  contents: write
  actions: write

env:
  TZ: Asia/Shanghai

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android 版本'
        required: true
        default: 'android14'
        type: choice
        options:
          - android14
          - android15
          - android16
      kernel_version:
        description: '内核版本'
        required: true
        default: '6.1'
        type: choice
        options:
          - '6.1'
          - '6.6'
          - '6.12'
      sub_level:
        description: '内核子版本号 (如 118、124 等)'
        required: true
        default: '118'
        type: string
      ksu_type:
        description: 'KernelSU 变体'
        required: true
        default: 'sukisu'
        type: choice
        options:
          - sukisu
          - ksunext
          - mksu
          - ksu
      susfs_enable:
        description: '启用 SUSFS'
        required: true
        default: true
        type: boolean
      kpm_enable:
        description: '启用 KPM (仅 SukiSU)'
        required: true
        default: false
        type: boolean
      features:
        description: '额外功能 (逗号分隔: lz4kd,ipset,bbg,rekernel,wireguard)'
        required: false
        default: 'ipset,bbg,wireguard'
        type: string
      kernel_suffix:
        description: '内核后缀 (留空使用默认)'
        required: false
        default: ''
        type: string
      create_release:
        description: '创建 Release'
        required: false
        default: false
        type: boolean

jobs:
  build:
    name: "构建 ${{ inputs.android_version }}-${{ inputs.kernel_version }}.${{ inputs.sub_level }}"
    runs-on: ubuntu-latest
    
    env:
      # 解析 features 输入
      LZ4KD_ENABLE: ${{ contains(inputs.features, 'lz4kd') }}
      IPSET_ENABLE: ${{ contains(inputs.features, 'ipset') }}
      BBG_ENABLE: ${{ contains(inputs.features, 'bbg') }}
      REKERNEL_ENABLE: ${{ contains(inputs.features, 'rekernel') }}
      WIREGUARD_ENABLE: ${{ contains(inputs.features, 'wireguard') }}
    
    steps:
      # ==================== 环境准备 ====================
      - name: 清理磁盘空间并安装依赖
        run: |
          echo "===== 初始磁盘空间 ====="
          df -h
          
          sudo apt-mark hold firefox
          sudo apt-mark hold libc-bin
          sudo apt purge man-db -y
          sudo rm -rf /var/lib/man-db/auto-update
          sudo apt update
          sudo apt-get install -y --no-install-recommends binutils python-is-python3 libssl-dev libelf-dev ccache
          
          echo "===== 清理后磁盘空间 ====="
          df -h

      - name: 设置环境变量
        run: |
          CONFIG="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.sub_level }}"
          ROOT="$GITHUB_WORKSPACE"
          KERNEL_ROOT="$ROOT/$CONFIG"
          SUSFS4KSU="$ROOT/susfs4ksu"
          KERNEL_PATCHES="$ROOT/kernel_patches"
          ANYKERNEL3="$ROOT/AnyKernel3"
          
          echo "CONFIG=$CONFIG" >> $GITHUB_ENV
          echo "ROOT=$ROOT" >> $GITHUB_ENV
          echo "KERNEL_ROOT=$KERNEL_ROOT" >> $GITHUB_ENV
          echo "SUSFS4KSU=$SUSFS4KSU" >> $GITHUB_ENV
          echo "KERNEL_PATCHES=$KERNEL_PATCHES" >> $GITHUB_ENV
          echo "ANYKERNEL3=$ANYKERNEL3" >> $GITHUB_ENV
          echo "DEFCONFIG=$KERNEL_ROOT/common/arch/arm64/configs/gki_defconfig" >> $GITHUB_ENV
          
          mkdir -p "$KERNEL_ROOT"

      - name: 配置构建环境
        run: |
          AOSP_MIRROR=https://android.googlesource.com
          BRANCH=main-kernel-2025
          
          git clone $AOSP_MIRROR/kernel/prebuilts/build-tools -b $BRANCH --depth 1 kernel-build-tools &
          git clone $AOSP_MIRROR/platform/system/tools/mkbootimg -b $BRANCH --depth 1 mkbootimg &
          wait
          
          echo "AVBTOOL=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/bin/avbtool" >> $GITHUB_ENV
          echo "MKBOOTIMG=$GITHUB_WORKSPACE/mkbootimg/mkbootimg.py" >> $GITHUB_ENV
          echo "UNPACK_BOOTIMG=$GITHUB_WORKSPACE/mkbootimg/unpack_bootimg.py" >> $GITHUB_ENV
          echo "BOOT_SIGN_KEY_PATH=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/share/avb/testkey_rsa2048.pem" >> $GITHUB_ENV
          echo "PATH=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/bin:$PATH" >> $GITHUB_ENV
          
          # 配置 repo 工具
          mkdir -p ./git-repo
          curl -s https://storage.googleapis.com/git-repo-downloads/repo > ./git-repo/repo
          chmod a+rx ./git-repo/repo
          echo "REPO=$GITHUB_WORKSPACE/git-repo/repo" >> $GITHUB_ENV
          
          echo "构建环境配置完成"

      - name: 设置 boot 签名密钥
        env:
          BOOT_SIGN_KEY: ${{ secrets.BOOT_SIGN_KEY }}
        run: |
          if [ ! -z "$BOOT_SIGN_KEY" ]; then
            echo "$BOOT_SIGN_KEY" > ./kernel-build-tools/linux-x86/share/avb/testkey_rsa2048.pem
          fi

      - name: 克隆 AnyKernel3 和依赖
        run: |
          ANYKERNEL_BRANCH="gki-2.0"
          SUSFS_BRANCH="gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}"
          
          git clone https://github.com/WildKernels/AnyKernel3.git -b "$ANYKERNEL_BRANCH" &
          git clone https://github.com/WildKernels/kernel_patches.git &
          wait

      # ==================== 下载内核源码 ====================
      - name: 确定安全补丁级别
        id: patch_level
        run: |
          # 根据 kernel_version 和 sub_level 确定 os_patch_level
          KERNEL_VER="${{ inputs.kernel_version }}"
          SUB_LEVEL="${{ inputs.sub_level }}"
          
          get_patch_level() {
            local kv=$1
            local sl=$2
            
            case "$kv" in
              "6.1")
                # Android 14 - 6.1 映射表
                case "$sl" in
                  25) echo "2023-10" ;;
                  43) echo "2023-11" ;;
                  57) echo "2024-01" ;;
                  68) echo "2024-03" ;;
                  75) echo "2024-05" ;;
                  78) echo "2024-06" ;;
                  84) echo "2024-07" ;;
                  90) echo "2024-08" ;;
                  93) echo "2024-09" ;;
                  99) echo "2024-10" ;;
                  112) echo "2024-11" ;;
                  115) echo "2024-12" ;;
                  118) echo "2025-01" ;;
                  124) echo "2025-02" ;;
                  128) echo "2025-03" ;;
                  129) echo "2025-04" ;;
                  134) echo "2025-05" ;;
                  138) echo "2025-06" ;;
                  141) echo "2025-07" ;;
                  145) echo "2025-09" ;;
                  *) echo "lts" ;;
                esac
                ;;
              "6.6")
                # Android 15 - 6.6 映射表
                case "$sl" in
                  30) echo "2024-08" ;;
                  46) echo "2024-09" ;;
                  50) echo "2024-10" ;;
                  56) echo "2024-11" ;;
                  57) echo "2024-12" ;;
                  58) echo "2025-01" ;;
                  66) echo "2025-02" ;;
                  77) echo "2025-03" ;;
                  82) echo "2025-04" ;;
                  87) echo "2025-05" ;;
                  89) echo "2025-06" ;;
                  92) echo "2025-07" ;;
                  98) echo "2025-09" ;;
                  102) echo "2025-10" ;;
                  *) echo "lts" ;;
                esac
                ;;
              "6.12")
                # Android 16 - 6.12 映射表
                case "$sl" in
                  5) echo "2025-03" ;;
                  8) echo "2025-04" ;;
                  13) echo "2025-05" ;;
                  17) echo "2025-06" ;;
                  22) echo "2025-07" ;;
                  31) echo "2025-09" ;;
                  *) echo "lts" ;;
                esac
                ;;
              *)
                echo "lts"
                ;;
            esac
          }
          
          OS_PATCH_LEVEL=$(get_patch_level "$KERNEL_VER" "$SUB_LEVEL")
          echo "OS_PATCH_LEVEL=$OS_PATCH_LEVEL" >> $GITHUB_ENV
          echo "os_patch_level=$OS_PATCH_LEVEL" >> $GITHUB_OUTPUT
          echo "内核 $KERNEL_VER.$SUB_LEVEL 对应安全补丁级别: $OS_PATCH_LEVEL"

      - name: 下载内核源码
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          echo "=== 下载内核源码 ==="
          FORMATTED_BRANCH="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ env.OS_PATCH_LEVEL }}"
          echo "分支: common-${FORMATTED_BRANCH}"
          
          $REPO init --depth=1 \
            --u https://android.googlesource.com/kernel/manifest \
            -b "common-${FORMATTED_BRANCH}" \
            --repo-rev=v2.16
          
          # 检查是否为 deprecated 分支
          REMOTE_BRANCH=$(git ls-remote https://android.googlesource.com/kernel/common "${FORMATTED_BRANCH}" 2>/dev/null || true)
          if echo "$REMOTE_BRANCH" | grep -q deprecated; then
            echo "分支已弃用，更新 manifest..."
            sed -i "s/\"${FORMATTED_BRANCH}\"/\"deprecated\/${FORMATTED_BRANCH}\"/g" .repo/manifests/default.xml
          fi
          
          $REPO --trace sync -c -j$(nproc --all) --no-tags --fail-fast
          
          # 获取实际 sublevel (验证)
          if [ -f "common/Makefile" ]; then
            ACTUAL_SUBLEVEL=$(grep '^SUBLEVEL = ' common/Makefile | awk '{print $3}')
            echo "SUBLEVEL=$ACTUAL_SUBLEVEL" >> $GITHUB_ENV
            echo "实际内核版本: ${{ inputs.kernel_version }}.$ACTUAL_SUBLEVEL"
          else
            echo "SUBLEVEL=${{ inputs.sub_level }}" >> $GITHUB_ENV
          fi

      - name: 清理 ABI 保护和 dirty 后缀
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          # 移除 ABI 保护文件和 BUILD.bazel 中的引用
          rm -rf common/android/abi_gki_protected_exports_* || true
          perl -pi -e 's/^\s*"protected_exports_list"\s*:\s*"android\/abi_gki_protected_exports_aarch64",\s*$//;' common/BUILD.bazel || true
          
          # 移除 dirty 后缀
          sed -i "/stable_scmversion_cmd/s/-maybe-dirty//g" build/kernel/kleaf/impl/stamp.bzl || true
          sed -i 's/ -dirty//g' common/scripts/setlocalversion || true

      # ==================== 添加 KernelSU ====================
      - name: 添加 KernelSU
        id: ksu_version
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          echo "=== 添加 KernelSU (${{ inputs.ksu_type }}) ==="
          
          case "${{ inputs.ksu_type }}" in
            sukisu)
              echo "配置 SukiSU Ultra..."
              curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-main
              cd KernelSU
              
              GIT_HASH=$(git rev-parse --short=8 HEAD)
              KSU_VERSION=$(expr $(git rev-list --count main 2>/dev/null || echo 0) + 37185)
              
              # 获取 API 版本
              for i in {1..3}; do
                KSU_API=$(curl -s "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/susfs-main/kernel/Makefile" | \
                  grep -m1 "KSU_VERSION_API :=" | awk -F'= ' '{print $2}' | tr -d '[:space:]')
                [ -n "$KSU_API" ] && break || sleep 1
              done
              [ -z "$KSU_API" ] && KSU_API="3.1.7"
              
              # 写入版本信息
              echo "" >> kernel/Makefile
              echo "# KSU Version Info" >> kernel/Makefile
              echo "KSU_VERSION_API := $KSU_API" >> kernel/Makefile
              echo "KSU_VERSION_FULL := v$KSU_API-$GIT_HASH@amuae" >> kernel/Makefile
              echo "ccflags-y += -DKSU_VERSION=$KSU_VERSION" >> kernel/Makefile
              echo "SukiSU 版本: v$KSU_API-$GIT_HASH ($KSU_VERSION)"
              ;;
              
            ksunext)
              echo "配置 KernelSU Next..."
              curl -LSs "https://raw.githubusercontent.com/pershoot/KernelSU-Next/next-susfs/kernel/setup.sh" | bash -s next-susfs
              cd KernelSU-Next
              KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/pershoot/KernelSU-Next/commits?sha=next&per_page=1" | \
                grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') + 10200)
              sed -i "s/DKSU_VERSION=11998/DKSU_VERSION=${KSU_VERSION}/" kernel/Makefile
              ;;
              
            mksu)
              echo "配置 MKSU (5ec1cff)..."
              curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/main/kernel/setup.sh" | bash -s main
              cd KernelSU
              KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/5ec1cff/KernelSU/commits?sha=main&per_page=1" | \
                grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') + 30000)
              sed -i "s/DKSU_VERSION=16/DKSU_VERSION=${KSU_VERSION}/" kernel/Kbuild
              ;;
              
            ksu)
              echo "配置原版 KernelSU..."
              curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
              cd KernelSU
              KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/tiann/KernelSU/commits?sha=main&per_page=1" | \
                grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') + 30000)
              sed -i "s/DKSU_VERSION=16/DKSU_VERSION=${KSU_VERSION}/" kernel/Kbuild
              ;;
          esac
          
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT

      # ==================== 应用 SUSFS 补丁 ====================
      - name: 应用 SUSFS 补丁
        if: inputs.susfs_enable
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          echo "=== 应用 SUSFS 补丁 ==="
          
          case "${{ inputs.ksu_type }}" in
            sukisu)
              git clone https://github.com/ShirkNeko/susfs4ksu.git -b gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}
              git clone https://github.com/ShirkNeko/SukiSU_patch.git
              
              cp susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch common/
              cp susfs4ksu/kernel_patches/fs/* common/fs/
              cp susfs4ksu/kernel_patches/include/linux/* common/include/linux/
              cp SukiSU_patch/69_hide_stuff.patch common/
              
              cd common
              patch -p1 < 50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch || true
              patch -p1 < 69_hide_stuff.patch || true
              ;;
              
            ksunext)
              git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}
              cd susfs4ksu && git checkout a162e2469d0b472545e5e46457eee171c0975fb0 && cd ..
              git clone https://github.com/WildKernels/kernel_patches.git
              
              cp susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch common/
              cp susfs4ksu/kernel_patches/fs/* common/fs/
              cp susfs4ksu/kernel_patches/include/linux/* common/include/linux/
              cp kernel_patches/next/scope_min_manual_hooks_v1.5.patch common/
              cp kernel_patches/69_hide_stuff.patch common/
              
              cd common
              patch -p1 < 50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch || true
              patch -p1 -N -F 3 < scope_min_manual_hooks_v1.5.patch || true
              patch -p1 -N -F 3 < 69_hide_stuff.patch || true
              
              # 添加 WildKSU 管理器支持
              cd drivers/kernelsu
              wget -q https://github.com/WildKernels/kernel_patches/raw/main/next/susfs_fix_patches/v1.5.12/fix_apk_sign.c.patch
              patch -p2 -N -F 3 < fix_apk_sign.c.patch || true
              ;;
              
            mksu|ksu)
              git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}
              git clone https://github.com/ShirkNeko/SukiSU_patch.git
              
              cp susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch KernelSU/
              cp susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch common/
              cp susfs4ksu/kernel_patches/fs/* common/fs/
              cp susfs4ksu/kernel_patches/include/linux/* common/include/linux/
              cp SukiSU_patch/69_hide_stuff.patch common/
              
              cd KernelSU
              patch -p1 < 10_enable_susfs_for_ksu.patch || true
              
              if [ "${{ inputs.ksu_type }}" == "mksu" ]; then
                wget -q https://github.com/cctv18/oppo_oplus_realme_sm8650/raw/main/other_patch/mksu_supercalls.patch
                patch -p1 < mksu_supercalls.patch || true
              fi
              wget -q https://github.com/cctv18/oppo_oplus_realme_sm8650/raw/main/other_patch/fix_umount.patch
              patch -p1 < fix_umount.patch || true
              
              cd ../common
              patch -p1 < 50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch || true
              patch -p1 -N -F 3 < 69_hide_stuff.patch || true
              ;;
          esac

      # ==================== 应用性能补丁 ====================
      - name: 克隆补丁仓库
        run: |
          git clone https://github.com/WildKernels/kernel_patches.git --depth=1 || true

      - name: 应用性能优化补丁
        working-directory: ${{ env.KERNEL_ROOT }}/common
        run: |
          echo "=== 应用性能优化补丁 ==="
          PATCHES_DIR="$ROOT/kernel_patches/common"
          
          # 内存优化
          [ -f "$PATCHES_DIR/optimized_mem_operations.patch" ] && \
            patch -p1 --forward < "$PATCHES_DIR/optimized_mem_operations.patch" || true
          
          # 文件结构对齐
          [ -f "$PATCHES_DIR/file_struct_8bytes_align.patch" ] && \
            patch -p1 --forward < "$PATCHES_DIR/file_struct_8bytes_align.patch" || true
          
          # 缓存压力优化
          [ -f "$PATCHES_DIR/reduce_cache_pressure.patch" ] && \
            patch -p1 --forward < "$PATCHES_DIR/reduce_cache_pressure.patch" || true
          
          # 页面清除优化
          if [ -f "$PATCHES_DIR/clear_page_16bytes_align.patch" ]; then
            if [ "$(printf '%s\n' "${{ inputs.kernel_version }}" "5.16" | sort -V | head -n1)" = "${{ inputs.kernel_version }}" ]; then
              patch -p1 --forward < "$PATCHES_DIR/clear_page_16bytes_align.patch" || true
            else
              sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' \
                "$PATCHES_DIR/clear_page_16bytes_align.patch" > clear_page_pi.patch
              patch -p1 -F3 --forward < clear_page_pi.patch || true
            fi
          fi
          
          echo "性能优化补丁应用完成"

      - name: 应用 LZ4KD 压缩补丁
        if: env.LZ4KD_ENABLE == 'true'
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          echo "=== 应用 LZ4KD 补丁 ==="
          if [ ! -d "SukiSU_patch" ]; then
            git clone https://github.com/ShirkNeko/SukiSU_patch.git
          fi
          
          cd common
          cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./include/linux/
          cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./lib/
          cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./crypto/
          cp ../SukiSU_patch/other/zram/zram_patch/${{ inputs.kernel_version }}/lz4kd.patch ./
          patch -p1 -F 3 < lz4kd.patch || true

      # ==================== 添加内核功能 ====================
      - name: 添加 BBG 基带保护
        if: env.BBG_ENABLE == 'true'
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          echo "=== 添加 BBG 基带保护 ==="
          echo "CONFIG_BBG=y" >> "${{ env.DEFCONFIG }}"
          
          cd common/security
          wget -q https://github.com/cctv18/Baseband-guard/archive/refs/heads/master.zip
          unzip -q master.zip
          mv Baseband-guard-master baseband-guard
          
          echo 'obj-$(CONFIG_BBG) += baseband-guard/' >> Makefile
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' Kconfig
          
          awk '
          /endmenu/ { last_endmenu_line = NR }
          { lines[NR] = $0 }
          END {
            for (i=1; i<=NR; i++) {
              if (i == last_endmenu_line) {
                sub(/endmenu/, "", lines[i]);
                print lines[i] "source \"security/baseband-guard/Kconfig\""
                print ""
                print "endmenu"
              } else {
                print lines[i]
              }
            }
          }' Kconfig > Kconfig.tmp && mv Kconfig.tmp Kconfig
          
          sed -i 's/selinuxfs.o //g' selinux/Makefile
          sed -i 's/hooks.o //g' selinux/Makefile
          cat baseband-guard/sepatch.txt >> selinux/Makefile

      - name: 添加 Re-Kernel 支持
        if: env.REKERNEL_ENABLE == 'true'
        working-directory: ${{ env.KERNEL_ROOT }}/common
        run: |
          echo "=== 添加 Re-Kernel 支持 ==="
          echo "CONFIG_RE_KERNEL=y" >> "${{ env.DEFCONFIG }}"
          
          curl -LSs "https://raw.githubusercontent.com/AuroraNova6/ReKernel/main/kernel/re_kernel.c" -o kernel/re_kernel.c
          echo "obj-\$(CONFIG_RE_KERNEL) += re_kernel.o" >> kernel/Makefile
          
          # 添加 Kconfig
          echo "" >> kernel/Kconfig
          echo "config RE_KERNEL" >> kernel/Kconfig
          echo "    bool \"Re-Kernel support for enhanced app freezing\"" >> kernel/Kconfig
          echo "    default n" >> kernel/Kconfig
          echo "    help" >> kernel/Kconfig
          echo "      Enable Re-Kernel support for enhanced application freezing capabilities." >> kernel/Kconfig

      # ==================== 配置内核 ====================
      - name: 配置内核选项
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          echo "=== 配置内核选项 ==="
          DEFCONFIG="${{ env.DEFCONFIG }}"
          
          # KernelSU 配置
          echo "" >> "$DEFCONFIG"
          echo "# KernelSU Configuration" >> "$DEFCONFIG"
          echo "CONFIG_KSU=y" >> "$DEFCONFIG"
          
          # KPM 支持 (仅 SukiSU)
          if [[ "${{ inputs.kpm_enable }}" == "true" && "${{ inputs.ksu_type }}" == "sukisu" ]]; then
            echo "CONFIG_KPM=y" >> "$DEFCONFIG"
          fi
          
          # SUSFS 配置
          if [ "${{ inputs.susfs_enable }}" == "true" ]; then
            echo "" >> "$DEFCONFIG"
            echo "# SUSFS Configuration" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> "$DEFCONFIG"
            echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> "$DEFCONFIG"
          fi
          
          # Mountify 支持
          echo "" >> "$DEFCONFIG"
          echo "# Mountify Support" >> "$DEFCONFIG"
          echo "CONFIG_TMPFS_XATTR=y" >> "$DEFCONFIG"
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> "$DEFCONFIG"
          
          # 网络配置
          echo "" >> "$DEFCONFIG"
          echo "# Networking" >> "$DEFCONFIG"
          echo "CONFIG_IP_NF_TARGET_TTL=y" >> "$DEFCONFIG"
          echo "CONFIG_IP6_NF_TARGET_HL=y" >> "$DEFCONFIG"
          echo "CONFIG_IP6_NF_MATCH_HL=y" >> "$DEFCONFIG"
          
          # Wireguard
          if [ "${{ env.WIREGUARD_ENABLE }}" == "true" ]; then
            echo "" >> "$DEFCONFIG"
            echo "# Wireguard VPN" >> "$DEFCONFIG"
            echo "CONFIG_WIREGUARD=y" >> "$DEFCONFIG"
          fi
          
          # IPSet 支持
          if [ "${{ env.IPSET_ENABLE }}" == "true" ]; then
            echo "" >> "$DEFCONFIG"
            echo "# IPSet Support" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_MAX=65534" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_BITMAP_IP=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_BITMAP_IPMAC=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_BITMAP_PORT=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IP=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPMARK=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPPORT=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPPORTIP=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPPORTNET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_IPMAC=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_MAC=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETPORTNET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETNET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETPORT=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_HASH_NETIFACE=y" >> "$DEFCONFIG"
            echo "CONFIG_IP_SET_LIST_SET=y" >> "$DEFCONFIG"
            echo "CONFIG_IP6_NF_NAT=y" >> "$DEFCONFIG"
            echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y" >> "$DEFCONFIG"
          fi
          
          # LZ4KD 配置
          if [ "${{ env.LZ4KD_ENABLE }}" == "true" ]; then
            echo "" >> "$DEFCONFIG"
            echo "# LZ4KD Compression" >> "$DEFCONFIG"
            echo "CONFIG_ZSMALLOC=y" >> "$DEFCONFIG"
            echo "CONFIG_CRYPTO_LZ4HC=y" >> "$DEFCONFIG"
            echo "CONFIG_CRYPTO_LZ4K=y" >> "$DEFCONFIG"
            echo "CONFIG_CRYPTO_LZ4KD=y" >> "$DEFCONFIG"
            echo "CONFIG_CRYPTO_842=y" >> "$DEFCONFIG"
          fi
          
          # 编译优化
          echo "" >> "$DEFCONFIG"
          echo "# Build Optimization" >> "$DEFCONFIG"
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> "$DEFCONFIG"
          echo "CONFIG_HEADERS_INSTALL=n" >> "$DEFCONFIG"
          
          # 禁用 defconfig 检查
          sed -i 's/check_defconfig//' common/build.config.gki || true
          
          echo "内核配置完成"

      - name: 修改内核名称
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          SUFFIX="${{ inputs.kernel_suffix }}"
          if [ -z "$SUFFIX" ]; then
            SUFFIX="${{ inputs.android_version }}-${{ inputs.ksu_type }}"
          fi
          
          sed -i "\$s|echo \"\\\$res\"|echo \"-$SUFFIX\"|" common/scripts/setlocalversion
          echo "内核后缀: -$SUFFIX"

      # ==================== 构建内核 ====================
      - name: 构建内核
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          echo "=== 开始构建内核 ==="
          
          # 构建 (Bazel 有自己的缓存系统，无需 ccache)
          if [ -f "build/build.sh" ]; then
            LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh
          else
            tools/bazel build --config=fast --config=stamp --lto=thin //common:kernel_aarch64_dist
          fi
          
          echo "内核构建完成"

      # KPM 后处理 (仅对 SukiSU + KPM 生效)
      - name: 应用 KPM 补丁
        if: inputs.ksu_type == 'SukiSU' && inputs.kpm_enable == true
        run: |
          echo "=== 应用 KPM 补丁 ==="
          cd $KERNEL_ROOT
          
          # 找到 Image 文件位置
          if [ -f "out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image" ]; then
            IMAGE_DIR="out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist"
          elif [ -f "bazel-bin/common/kernel_aarch64/Image" ]; then
            IMAGE_DIR="bazel-bin/common/kernel_aarch64"
          else
            echo "错误: 找不到 Image 文件"
            exit 1
          fi
          
          cd "$IMAGE_DIR"
          curl -LO https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch/releases/latest/download/patch_linux
          chmod +x patch_linux
          ./patch_linux
          rm -f Image
          mv oImage Image
          echo "KPM 补丁应用完成"

      # ==================== 打包 ====================
      - name: 打包内核
        run: |
          echo "=== 打包内核 ==="
          
          # 查找 Image 文件
          if [ -f "$KERNEL_ROOT/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image" ]; then
            IMAGE_PATH="$KERNEL_ROOT/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image"
          elif [ -f "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" ]; then
            IMAGE_PATH="$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image"
          else
            echo "错误: 找不到 Image 文件"
            find $KERNEL_ROOT -name "Image" -type f 2>/dev/null || true
            exit 1
          fi
          
          cp "$IMAGE_PATH" AnyKernel3/Image
          
          # 创建 ZIP
          cd AnyKernel3
          ZIP_NAME="${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}-${{ inputs.android_version }}-${{ inputs.ksu_type }}.zip"
          zip -r9 "../$ZIP_NAME" * -x .git .gitignore README.md
          
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "打包完成: $ZIP_NAME"

      - name: 生成 boot.img
        run: |
          echo "=== 生成 boot.img ==="
          mkdir -p bootimgs
          
          if [ -f "$KERNEL_ROOT/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image" ]; then
            cp "$KERNEL_ROOT/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image" bootimgs/
            cp "$KERNEL_ROOT/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image.lz4" bootimgs/ 2>/dev/null || true
          else
            cp "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image" bootimgs/
            cp "$KERNEL_ROOT/bazel-bin/common/kernel_aarch64/Image.lz4" bootimgs/ 2>/dev/null || true
          fi
          
          cd bootimgs
          gzip -n -k -f -9 Image
          
          # 创建 boot.img
          $MKBOOTIMG --header_version 4 --kernel Image --output boot.img
          $AVBTOOL add_hash_footer --partition_name boot --partition_size $((64 * 1024 * 1024)) \
            --image boot.img --algorithm SHA256_RSA2048 --key $BOOT_SIGN_KEY_PATH
          
          BOOT_NAME="${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}-${{ inputs.android_version }}-${{ inputs.ksu_type }}-boot.img"
          cp boot.img "../$BOOT_NAME"
          echo "BOOT_NAME=$BOOT_NAME" >> $GITHUB_ENV

      # ==================== 上传 ====================
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.ksu_type }}-kernel
          path: |
            ${{ env.ZIP_NAME }}
            ${{ env.BOOT_NAME }}
          compression-level: 0

      - name: 创建 Release
        if: inputs.create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}-${{ github.run_number }}
          name: "GKI ${{ inputs.android_version }} 内核 ${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}"
          body: |
            ## 构建信息
            - **Android 版本**: ${{ inputs.android_version }}
            - **内核版本**: ${{ inputs.kernel_version }}.${{ env.SUBLEVEL }}
            - **KernelSU**: ${{ inputs.ksu_type }} (v${{ env.KSUVER }})
            - **SUSFS**: ${{ inputs.susfs_enable }}
            - **额外功能**: ${{ inputs.features }}
          files: |
            ${{ env.ZIP_NAME }}
            ${{ env.BOOT_NAME }}
          draft: false
          prerelease: false
